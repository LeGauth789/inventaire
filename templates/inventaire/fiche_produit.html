{% extends 'inventaire/base.html' %}

{% block title %}Fiche produit : {{ produit.nom }}{% endblock %}

{% block content %}
  <h1>Fiche produit : {{ produit.nom }}</h1>

  <ul class="list-group mb-4">
    <li class="list-group-item"><strong>Stock :</strong> {{ produit.stock }}</li>
    <li class="list-group-item"><strong>Condition de stockage :</strong> {{ produit.condition_stock }}</li>
    <li class="list-group-item"><strong>Numéro de FDS :</strong> {{ produit.nb_FDS }}</li>
    <li class="list-group-item">Modifier
        <a href="{% url 'modifier_produit' produit.pk %}">
            <img src="/media/img/pencil-square.svg" alt="Modifier" width="20" height="20">
        </a>
    </li>
    <li class="list-group-item">
       <h2>Fiche de sécurité</h2>
      {% if produit.fichier_FDS %}
       
        <a href="{{ produit.fichier_FDS.url }}" class="btn btn-info mb-3"target="_blank">Voir la fiche PDF</a>
        <a href="{% url 'upload_pdf' produit.pk %}" class="btn btn-info mb-3">
          Modifier la fiche PDF
        </a>
        {% else %}
        <p>
          <a href="{% url 'upload_pdf' produit.pk %}" class="btn btn-info mb-3">
              Ajouter / Modifier la fiche PDF
          </a>
        </p>
      {% endif %}
    </li>
        <li class="list-group-item">
          <h2>Certificat d'analyse</h2>
      {% if produit.fichier_CA %}
        
        <a href="{{ produit.fichier_CA.url }}" class="btn btn-info mb-3"target="_blank">Voir la fiche CA</a>
        <a href="{% url 'upload_pdf' produit.pk %}" class="btn btn-info mb-3">
          Modifier la fiche PDF
        </a>
        {% else %}
        <p>
          <a href="{% url 'upload_pdf' produit.pk %}" class="btn btn-info mb-3">
              Ajouter / Modifier la fiche PDF
          </a>
        </p>
      {% endif %}
    </li>
    <li class="list-group-item">
      <form action="{% url 'supprimer_produit' produit.id %}" method="post" onsubmit="return confirm('Supprimer ce produit définitivement ?');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">
        Supprimer ce produit
      </button>
    </form>
    </li>
  </ul>



  <h2>Historique des mouvements</h2>
  <table class="table table-striped table-bordered">
    <thead class="table-secondary">
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Quantité</th>
        <th>Utilisateur</th>
        <th>Fournisseur</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody>
      <a href="{% url 'gerer_mouvement_stock' produit.id %}" class="btn btn-warning mb-3">
        Ajouter / Retirer du stock
      </a>

      {% for mouvement in mouvements %}
      <tr>
        <td>{{ mouvement.date|date:"d-m-Y" }}</td>
        <td>{{ mouvement.get_type_mouvement_display }}</td>
        <td>
          {% if mouvement.type_mouvement == 'RETRAIT' %}
            -{{ mouvement.quantite }}
          {% else %}
            +{{ mouvement.quantite }}
          {% endif %}
        </td>
        <td>{{ mouvement.utilisateur.get_full_name|default:mouvement.utilisateur.username }}</td>
        <td>{{ mouvement.fournisseur|default:"-" }}</td>
        <td>{{ mouvement.commentaire|default:"-" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" class="text-center">Aucun mouvement enregistré.</td></tr>
      {% endfor %}

    </tbody>
  </table>

  <a href="{% url 'liste_produits' %}" class="btn btn-secondary mt-3">← Retour à la liste</a>
{% endblock %}
